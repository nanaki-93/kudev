# Task 2.1: Define Builder Interface & Types

## Overview

This task establishes the **Builder abstraction** that allows different image building implementations. The interface is designed to be minimal, clear, and extensible for future builders (e.g., Buildpacks, ko, Podman).

**Effort**: ~2-3 hours  
**Complexity**: üü¢ Beginner-Friendly  
**Dependencies**: Phase 1 (Config, Logger)  
**Files to Create**:
- `pkg/builder/types.go` ‚Äî Builder interface and option types

---

## What You're Building

A set of Go types and interfaces that:
1. **Abstract** the image building process
2. **Define** input options (source, Dockerfile, tags)
3. **Define** output result (image reference, ID)
4. **Support** factory pattern for multiple builders
5. **Document** each field with clear intent

---

## The Problem This Solves

Without a proper abstraction:
```go
// Tightly coupled to Docker
func buildImage() {
    exec.Command("docker", "build", ...)
}

// Can't easily switch to Podman, Buildpacks, etc.
// Hard to test (subprocess dependency)
// No clear contract for build parameters
```

With a builder interface:
```go
// Swap implementations easily
var builder Builder = docker.NewDockerBuilder(logger)
// or: builder = podman.NewPodmanBuilder(logger)

result, err := builder.Build(ctx, opts)
// Works the same regardless of implementation!
```

---

## Interface Design Philosophy

### Minimal Interface Principle

The `Builder` interface should have **only essential methods**:

```go
type Builder interface {
    Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
    Name() string
}
```

**Why minimal?**
- Easy to implement new builders
- Easy to mock for testing
- Less coupling between components
- Follows Go idioms (small interfaces)

### Options Struct Pattern

Instead of many function parameters:
```go
// ‚ùå Hard to maintain, extend, and read
func Build(ctx context.Context, sourceDir, dockerfile, imageName, tag string, 
           buildArgs map[string]string, ...) 
```

Use an options struct:
```go
// ‚úÖ Clear, extensible, documented
func Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
```

---

## Complete Type Definitions

### File Structure

```
pkg/builder/
‚îú‚îÄ‚îÄ types.go           ‚Üê You'll create this (Task 2.1)
‚îú‚îÄ‚îÄ tagger.go          ‚Üê Task 2.4
‚îî‚îÄ‚îÄ docker/
    ‚îî‚îÄ‚îÄ builder.go     ‚Üê Task 2.2
```

### Builder Interface

```go
// pkg/builder/types.go

package builder

import (
    "context"
)

// Builder abstracts different image building implementations.
// Implementations include Docker CLI, Podman, Buildpacks, etc.
type Builder interface {
    // Build creates a container image from source code.
    // It returns an ImageRef containing the full reference and image ID.
    // The context can be used to cancel long-running builds.
    Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
    
    // Name returns the builder's identifier (e.g., "docker", "podman").
    // Used for logging and error messages.
    Name() string
}
```

**Design Notes**:
- `context.Context` enables timeout and cancellation
- Single `Build()` method for all building operations
- `Name()` helps with logging and debugging

### BuildOptions Struct

```go
// BuildOptions contains all parameters needed for building an image.
// All paths should be absolute or relative to the project root.
type BuildOptions struct {
    // SourceDir is the absolute path to the project root directory.
    // This becomes the Docker build context.
    // Example: "/home/user/myproject"
    SourceDir string
    
    // DockerfilePath is the path to the Dockerfile, relative to SourceDir.
    // Example: "./Dockerfile" or "./docker/Dockerfile.dev"
    DockerfilePath string
    
    // ImageName is the base name for the output image (without tag or registry).
    // Example: "myapp" (not "docker.io/user/myapp")
    ImageName string
    
    // ImageTag is the tag to apply to the built image.
    // Generated by the Tagger based on source hash.
    // Example: "kudev-a1b2c3d4"
    ImageTag string
    
    // BuildArgs are key-value pairs passed as --build-arg to Docker.
    // Optional. Used for build-time variables.
    // Example: {"VERSION": "1.0.0", "ENV": "dev"}
    BuildArgs map[string]string
    
    // Target is the target stage in a multi-stage Dockerfile.
    // Optional. If empty, builds all stages.
    // Example: "builder" or "runtime"
    Target string
    
    // NoCache disables Docker's build cache.
    // Optional. Default is false (use cache).
    NoCache bool
}
```

**Field Explanations**:

| Field | Required | Purpose |
|-------|----------|---------|
| `SourceDir` | ‚úÖ Yes | Docker build context path |
| `DockerfilePath` | ‚úÖ Yes | Location of Dockerfile |
| `ImageName` | ‚úÖ Yes | Output image name |
| `ImageTag` | ‚úÖ Yes | Output image tag |
| `BuildArgs` | ‚ùå No | Build-time variables |
| `Target` | ‚ùå No | Multi-stage build target |
| `NoCache` | ‚ùå No | Force fresh build |

### ImageRef Struct

```go
// ImageRef represents a built container image reference.
// It contains both the human-readable reference and the unique image ID.
type ImageRef struct {
    // FullRef is the complete image reference in "name:tag" format.
    // Example: "myapp:kudev-a1b2c3d4"
    FullRef string
    
    // ID is the unique identifier assigned by Docker (sha256 digest).
    // Example: "sha256:abc123def456..."
    ID string
    
    // Digest is the content-addressable digest (if available).
    // Example: "sha256:abc123def456..."
    // May be empty for local builds without registry push.
    Digest string
}

// String returns the FullRef for convenient logging.
func (r *ImageRef) String() string {
    return r.FullRef
}
```

**Why both FullRef and ID?**
- `FullRef`: Human-readable, used in K8s manifests
- `ID`: Unique identifier, used for cache checking
- `Digest`: Content-addressable, for registry operations

### Factory Function Type

```go
// BuilderFactory is a function that creates a new Builder instance.
// Used for dynamic builder selection based on configuration.
type BuilderFactory func() (Builder, error)
```

---

## Validation Helper

Add validation to BuildOptions:

```go
// Validate checks that all required fields are set and valid.
// Returns an error describing any issues found.
func (o BuildOptions) Validate() error {
    var errors []string
    
    if o.SourceDir == "" {
        errors = append(errors, "SourceDir is required")
    }
    
    if o.DockerfilePath == "" {
        errors = append(errors, "DockerfilePath is required")
    }
    
    if o.ImageName == "" {
        errors = append(errors, "ImageName is required")
    }
    
    if o.ImageTag == "" {
        errors = append(errors, "ImageTag is required")
    }
    
    if len(errors) > 0 {
        return fmt.Errorf("invalid BuildOptions: %s", strings.Join(errors, ", "))
    }
    
    return nil
}
```

---

## Complete Implementation

```go
// pkg/builder/types.go

package builder

import (
    "context"
    "fmt"
    "strings"
)

// Builder abstracts different image building implementations.
// Implementations include Docker CLI, Podman, Buildpacks, etc.
type Builder interface {
    // Build creates a container image from source code.
    // It returns an ImageRef containing the full reference and image ID.
    // The context can be used to cancel long-running builds.
    Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
    
    // Name returns the builder's identifier (e.g., "docker", "podman").
    // Used for logging and error messages.
    Name() string
}

// BuildOptions contains all parameters needed for building an image.
// All paths should be absolute or relative to the project root.
type BuildOptions struct {
    // SourceDir is the absolute path to the project root directory.
    // This becomes the Docker build context.
    // Example: "/home/user/myproject"
    SourceDir string
    
    // DockerfilePath is the path to the Dockerfile, relative to SourceDir.
    // Example: "./Dockerfile" or "./docker/Dockerfile.dev"
    DockerfilePath string
    
    // ImageName is the base name for the output image (without tag or registry).
    // Example: "myapp" (not "docker.io/user/myapp")
    ImageName string
    
    // ImageTag is the tag to apply to the built image.
    // Generated by the Tagger based on source hash.
    // Example: "kudev-a1b2c3d4"
    ImageTag string
    
    // BuildArgs are key-value pairs passed as --build-arg to Docker.
    // Optional. Used for build-time variables.
    // Example: {"VERSION": "1.0.0", "ENV": "dev"}
    BuildArgs map[string]string
    
    // Target is the target stage in a multi-stage Dockerfile.
    // Optional. If empty, builds all stages.
    // Example: "builder" or "runtime"
    Target string
    
    // NoCache disables Docker's build cache.
    // Optional. Default is false (use cache).
    NoCache bool
}

// Validate checks that all required fields are set and valid.
// Returns an error describing any issues found.
func (o BuildOptions) Validate() error {
    var errors []string
    
    if o.SourceDir == "" {
        errors = append(errors, "SourceDir is required")
    }
    
    if o.DockerfilePath == "" {
        errors = append(errors, "DockerfilePath is required")
    }
    
    if o.ImageName == "" {
        errors = append(errors, "ImageName is required")
    }
    
    if o.ImageTag == "" {
        errors = append(errors, "ImageTag is required")
    }
    
    if len(errors) > 0 {
        return fmt.Errorf("invalid BuildOptions: %s", strings.Join(errors, ", "))
    }
    
    return nil
}

// ImageRef represents a built container image reference.
// It contains both the human-readable reference and the unique image ID.
type ImageRef struct {
    // FullRef is the complete image reference in "name:tag" format.
    // Example: "myapp:kudev-a1b2c3d4"
    FullRef string
    
    // ID is the unique identifier assigned by Docker (sha256 digest).
    // Example: "sha256:abc123def456..."
    ID string
    
    // Digest is the content-addressable digest (if available).
    // Example: "sha256:abc123def456..."
    // May be empty for local builds without registry push.
    Digest string
}

// String returns the FullRef for convenient logging.
func (r *ImageRef) String() string {
    return r.FullRef
}

// BuilderFactory is a function that creates a new Builder instance.
// Used for dynamic builder selection based on configuration.
type BuilderFactory func() (Builder, error)
```

---

## Testing Your Types

### Unit Test File

Create `pkg/builder/types_test.go`:

```go
package builder

import (
    "testing"
)

func TestBuildOptionsValidate(t *testing.T) {
    tests := []struct {
        name    string
        opts    BuildOptions
        wantErr bool
    }{
        {
            name: "valid options",
            opts: BuildOptions{
                SourceDir:      "/project",
                DockerfilePath: "./Dockerfile",
                ImageName:      "myapp",
                ImageTag:       "kudev-abc123",
            },
            wantErr: false,
        },
        {
            name: "missing SourceDir",
            opts: BuildOptions{
                DockerfilePath: "./Dockerfile",
                ImageName:      "myapp",
                ImageTag:       "kudev-abc123",
            },
            wantErr: true,
        },
        {
            name: "missing DockerfilePath",
            opts: BuildOptions{
                SourceDir: "/project",
                ImageName: "myapp",
                ImageTag:  "kudev-abc123",
            },
            wantErr: true,
        },
        {
            name: "missing ImageName",
            opts: BuildOptions{
                SourceDir:      "/project",
                DockerfilePath: "./Dockerfile",
                ImageTag:       "kudev-abc123",
            },
            wantErr: true,
        },
        {
            name: "missing ImageTag",
            opts: BuildOptions{
                SourceDir:      "/project",
                DockerfilePath: "./Dockerfile",
                ImageName:      "myapp",
            },
            wantErr: true,
        },
        {
            name: "all fields missing",
            opts: BuildOptions{},
            wantErr: true,
        },
        {
            name: "with optional fields",
            opts: BuildOptions{
                SourceDir:      "/project",
                DockerfilePath: "./Dockerfile",
                ImageName:      "myapp",
                ImageTag:       "kudev-abc123",
                BuildArgs:      map[string]string{"VERSION": "1.0"},
                Target:         "runtime",
                NoCache:        true,
            },
            wantErr: false,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := tt.opts.Validate()
            if (err != nil) != tt.wantErr {
                t.Errorf("Validate() error = %v, wantErr %v", err, tt.wantErr)
            }
        })
    }
}

func TestImageRefString(t *testing.T) {
    ref := ImageRef{
        FullRef: "myapp:kudev-abc123",
        ID:      "sha256:abc123",
    }
    
    if ref.String() != "myapp:kudev-abc123" {
        t.Errorf("String() = %v, want %v", ref.String(), "myapp:kudev-abc123")
    }
}
```

### Run Tests

```bash
go test ./pkg/builder -v
```

---

## How Types Connect to Other Tasks

```
Task 2.1 (Types) ‚Üê You are here
    ‚Üì
    ‚îÇ BuildOptions, ImageRef used by:
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ Task 2.2 (Docker Builder)
    ‚îÇ   - Implements Builder interface
    ‚îÇ   - Uses BuildOptions as input
    ‚îÇ   - Returns ImageRef as output
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ Task 2.4 (Tagger)
    ‚îÇ   - Generates ImageTag for BuildOptions
    ‚îÇ
    ‚îî‚îÄ‚ñ∫ Task 2.5 (Registry Loader)
        - Uses ImageRef.FullRef to load image
```

---

## Critical Design Decisions Explained

### Decision 1: Interface vs. Struct

**Question**: Why an interface instead of a concrete struct?

**Answer**: 
- ‚úÖ Allows multiple implementations (Docker, Podman, Buildpacks)
- ‚úÖ Easy to mock in tests
- ‚úÖ Follows Go idiom "accept interfaces, return structs"
- ‚úÖ Enables runtime selection based on config

### Decision 2: BuildArgs as map[string]string

**Question**: Why map instead of []EnvVar like in config?

**Answer**:
- Build args are key-value pairs, map is natural fit
- Order doesn't matter for Docker build args
- Simpler to use: `opts.BuildArgs["VERSION"] = "1.0"`
- Different use case than env vars (build-time vs runtime)

### Decision 3: Separate ImageName and ImageTag

**Question**: Why not a single `ImageRef` field?

**Answer**:
- Tagger generates tag separately from image name
- Allows same image name with different tags
- Clearer separation of concerns
- Easier to validate each component

---

## Checklist for Task 2.1

- [ ] Create `pkg/builder/types.go`
- [ ] Define `Builder` interface with `Build()` and `Name()`
- [ ] Define `BuildOptions` struct with all fields
- [ ] Add `Validate()` method to `BuildOptions`
- [ ] Define `ImageRef` struct with `FullRef`, `ID`, `Digest`
- [ ] Add `String()` method to `ImageRef`
- [ ] Define `BuilderFactory` type
- [ ] Add doc comments for all types
- [ ] Add doc comments for all fields
- [ ] Create `pkg/builder/types_test.go`
- [ ] Write tests for `BuildOptions.Validate()`
- [ ] Write tests for `ImageRef.String()`
- [ ] Run `go fmt ./pkg/builder`
- [ ] Verify no compilation errors: `go build ./pkg/builder`
- [ ] Run tests: `go test ./pkg/builder -v`

---

## Common Mistakes to Avoid

‚ùå **Mistake 1**: Making the interface too large
```go
// Wrong - too many methods
type Builder interface {
    Build(...)
    Clean(...)
    ListImages(...)
    RemoveImage(...)
    Push(...)
}

// Right - minimal interface
type Builder interface {
    Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
    Name() string
}
```

‚ùå **Mistake 2**: Using `interface{}` for flexibility
```go
// Wrong - loses type safety
type BuildOptions struct {
    Extra interface{}
}

// Right - typed fields
type BuildOptions struct {
    Target  string
    NoCache bool
}
```

‚ùå **Mistake 3**: Not using context.Context
```go
// Wrong - no cancellation support
Build(opts BuildOptions) (*ImageRef, error)

// Right - supports timeout/cancellation
Build(ctx context.Context, opts BuildOptions) (*ImageRef, error)
```

‚ùå **Mistake 4**: Returning concrete type from factory
```go
// Wrong - locks to specific implementation
type BuilderFactory func() (*DockerBuilder, error)

// Right - returns interface
type BuilderFactory func() (Builder, error)
```

---

## Next Steps

1. **Complete this task** ‚Üê You are here
2. Move to **Task 2.2** ‚Üí Implement Docker Builder
3. Then **Task 2.3** ‚Üí Implement Hash Calculator
4. Docker Builder will implement the `Builder` interface
5. Hash Calculator will generate input for `ImageTag`

---

## References

- [Go Interfaces Best Practices](https://go.dev/doc/effective_go#interfaces)
- [Options Pattern in Go](https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis)
- [Docker Build Reference](https://docs.docker.com/engine/reference/commandline/build/)
- [Context Package](https://pkg.go.dev/context)

